# Инструкция по тестированию статистики статусов

## Что проверяем

Проверяем корректность подсчета статистики по статусам:
- **Просмотрено** (включая пересмотрено)
- **Отложено** (Хочу посмотреть) 
- **Брошено**
- **Скрыто** (blacklist)

## Как тестировать

### 1. Запуск сервера
```bash
npm run dev
```

### 2. Открыть тестовые страницы

#### Основная страница тестирования:
http://localhost:3000/test-status-stats.html

На этой странице отображается:
- Основная статистика из `/api/user/stats`
- Детальная отладочная информация из `/api/debug/stats`
- Сравнение результатов между двумя endpoint'ами
- Тестирование `/api/my-movies` с разными статусами

#### Дополнительная страница для аниме/мультфильмов:
http://localhost:3000/test-anime-cartoon-stats.html

### 3. Проверка логов

Смотреть логи в терминале, где запущен сервер. Должны появиться сообщения:

```
=== ПОДСЧЕТ СТАТИСТИКИ В /api/user/stats ===
User ID: [user_id]
MOVIE_STATUS_IDS: {WANT_TO_WATCH: 1, WATCHED: 2, REWATCHED: 3, DROPPED: 4}
Результаты подсчета в /api/user/stats:
WATCHED + REWATCHED: [число]
WANT_TO_WATCH: [число]
DROPPED: [число]
HIDDEN (blacklist): [число]

=== DEBUG ПОЛНЫЙ АНАЛИЗ ===
User ID: [user_id]

=== ПОДСЧЕТ ЗАПИСЕЙ ПО СТАТУСАМ ===
Результаты подсчета:
WANT_TO_WATCH (1): [число]
WATCHED (2): [число]
REWATCHED (3): [число]
DROPPED (4): [число]
WATCHED + REWATCHED: [число]
```

### 4. Сравнение результатов

На тестовой странице в разделе "Сравнение данных" должны быть зеленые галочки ✅ напротив каждого статуса. Если есть красные крести ❌ - есть расхождение.

### 5. Тестирование /api/my-movies

Нажать кнопку "Проверить /api/my-movies" - это покажет количество записей для каждого статуса из этого endpoint'а.

## Что должно работать правильно

1. **Просмотрено** = WATCHED + REWATCHED (оба статуса объединены)
2. **Отложено** = WANT_TO_WATCH 
3. **Брошено** = DROPPED
4. **Скрыто** = count из таблицы blacklist

## Возможные проблемы и их решения

### Проблема: Расхождения в подсчете
- **Причина**: Разная логика фильтрации в endpoint'ах
- **Решение**: Сравнить условия WHERE в запросах к базе данных

### Проблема: Неправильные ID статусов
- **Причина**: Несоответствие констант MOVIE_STATUS_IDS
- **Решение**: Проверить константы в `/src/lib/movieStatusConstants.ts`

### Проблема: Методы подсчета
- **Причина**: Один endpoint использует COUNT(), другой - findMany() + length
- **Решение**: Унифицировать методы подсчета

## Ожидаемые результаты

После исправления всех проблем:
- Все счетчики в профиле пользователя должны совпадать с реальным количеством записей
- Переход по ссылкам в статистике должен показывать правильное количество фильмов
- Типы контента (аниме/мультфильмы) должны считаться корректно
