name: Test Yandex Disk API

on:
  workflow_dispatch

jobs:
  test-yandex-disk:
    runs-on: ubuntu-latest

    steps:
      - name: Create test file
        run: |
          echo "Test from GitHub Actions - $(date)" > test_file.txt
          echo "Timestamp: $(date +%Y%m%d_%H%M%S)" >> test_file.txt
          cat test_file.txt

      - name: Create folder on Yandex Disk
        run: |
          TOKEN="${{ secrets.YANDEX_DISK_TOKEN }}"
          FOLDER_PATH="/CineChanceBackups"

          echo "=== Creating folder $FOLDER_PATH ==="
          curl -X PUT \
            -H "Authorization: OAuth $TOKEN" \
            "https://cloud-api.yandex.net/v1/disk/resources?path=$FOLDER_PATH" \
            -w "\nHTTP Status: %{http_code}\n"

      - name: Get upload URL and upload file
        run: |
          TOKEN="${{ secrets.YANDEX_DISK_TOKEN }}"
          FILENAME="test_file.txt"
          DEST_PATH="/CineChanceBackups/test_file.txt"

          echo "=== Step 1: Getting upload URL ==="
          UPLOAD_URL=$(curl -X GET \
            -H "Authorization: OAuth $TOKEN" \
            "https://cloud-api.yandex.net/v1/disk/resources/upload?path=$DEST_PATH" \
            2>/dev/null | grep -o '"href":"[^"]*"' | cut -d'"' -f4)

          echo "Upload URL: $UPLOAD_URL"

          echo ""
          echo "=== Step 2: Uploading file ==="
          curl -X PUT \
            -H "Authorization: OAuth $TOKEN" \
            --data-binary @"$FILENAME" \
            "$UPLOAD_URL" \
            -w "\nHTTP Status: %{http_code}\n"

      - name: Verify file exists
        run: |
          TOKEN="${{ secrets.YANDEX_DISK_TOKEN }}"

          echo "=== Files in /CineChanceBackups ==="
          curl -H "Authorization: OAuth $TOKEN" \
            "https://cloud-api.yandex.net/v1/disk/resources?path=/CineChanceBackups" \
            2>/dev/null | grep -o '"name":"[^"]*"'
