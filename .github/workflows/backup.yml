name: Database Backup to GitHub Releases

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install PostgreSQL client
        run: |
          # Добавляем репозиторий PostgreSQL для версии 17.x (совместимо с Neon 17.7)
          sudo apt-get update
          sudo apt-get install -y wget gnupg2 lsb-release
          wget -qO - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list
          sudo apt-get update
          sudo apt-get install -y postgresql-client-17 gzip
      
      - name: Debug - Show connection info
        run: |
          echo "=== Database Connection Debug ==="
          echo "DATABASE_URL is set: ${{ secrets.DATABASE_URL != '' }}"
          if [ "${{ secrets.DATABASE_URL }}" != "" ]; then
            HOST=$(echo "${{ secrets.DATABASE_URL }}" | sed -n 's/.*@\([^/]*\).*/\1/p')
            echo "Host: $HOST"
          else
            echo "WARNING: DATABASE_URL secret is not set!"
          fi
          echo "================================"
      
      - name: Test database connection
        run: |
          if [ "${{ secrets.DATABASE_URL }}" == "" ]; then
            echo "ERROR: DATABASE_URL secret is not set. Please add it to GitHub Actions secrets."
            exit 1
          fi
          echo "=== Testing database connection ==="
          pg_isready -d "${{ secrets.DATABASE_URL }}" || echo "Connection test returned: $?"
          echo "===================================="
      
      - name: Create database dump
        id: dump
        run: |
          if [ "${{ secrets.DATABASE_URL }}" == "" ]; then
            echo "ERROR: Cannot create dump without DATABASE_URL"
            exit 1
          fi
          
          DATE=$(date +%Y%m%d)
          FILENAME="cinechance_backup_${DATE}.sql.gz"
          
          echo "=== Starting dump ==="
          echo "Output file: $FILENAME"
          
          # Запускаем дамп
          pg_dump "${{ secrets.DATABASE_URL }}" 2>&1 | gzip > "$FILENAME"
          
          echo "=== Dump completed ==="
          
          if [ -f "$FILENAME" ]; then
            echo "File created: $FILENAME"
            ls -lh "$FILENAME"
            FILE_SIZE=$(stat -c%s "$FILENAME")
            echo "File size bytes: $FILE_SIZE"
            
            if [ $FILE_SIZE -gt 100 ]; then
              echo "File size is OK (>100 bytes)"
            else
              echo "WARNING: File too small, might be empty or error page"
            fi
          else
            echo "ERROR: File was not created!"
            exit 1
          fi
          
          echo "file=$FILENAME" >> $GITHUB_OUTPUT
          echo "tag=backup-$DATE" >> $GITHUB_OUTPUT
      
      - name: Install gh CLI
        run: sudo apt-get install -y gh
      
      - name: Configure gh
        run: |
          # Используем встроенный GITHUB_TOKEN (автоматически доступен)
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
      
      - name: Create GitHub Release
        run: |
          FILE_SIZE=$(ls -lh "${{ steps.dump.outputs.file }}" | awk '{print $5}')
          DATE_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
          TAG="${{ steps.dump.outputs.tag }}"
          
          echo "Creating release with tag: $TAG"
          
          echo "Автоматический бэкап базы данных CineChance - Дата: ${DATE_TIME} - Размер: ${FILE_SIZE}" > /tmp/release_notes.txt
          
          gh release create "$TAG" \
            --title "Database Backup $TAG" \
            --notes-file /tmp/release_notes.txt \
            --repo "${{ github.repository }}"
          
          echo "Release created successfully"
      
      - name: Verify release exists
        run: |
          TAG="${{ steps.dump.outputs.tag }}"
          echo "Checking if release exists: $TAG"
          gh release view "$TAG" --repo "${{ github.repository }}" || echo "Release not found!"
      
      - name: Upload Release Asset
        run: |
          TAG="${{ steps.dump.outputs.tag }}"
          FILE="${{ steps.dump.outputs.file }}"
          
          echo "Uploading $FILE to release $TAG"
          ls -lh "$FILE"
          
          gh release upload "$TAG" "$FILE" \
            --repo "${{ github.repository }}"
          
          echo "Upload completed"
      
      - name: Verify upload
        run: |
          TAG="${{ steps.dump.outputs.tag }}"
          echo "Verifying release assets for: $TAG"
          gh release view "$TAG" --repo "${{ github.repository }}" --json assets -q '.assets[].name'
      
      - name: Clean old releases
        run: |
          DAYS_TO_KEEP=14
          
          echo "Checking for releases older than $DAYS_TO_KEEP days..."
          
          for release in $(gh release list --repo "${{ github.repository }}" --json createdAt,tagName -q '.[] | select(.tagName | startswith("backup-")) | .tagName'); do
            CREATED_AT=$(gh release view "$release" --repo "${{ github.repository }}" --json createdAt -q '.createdAt')
            
            RELEASE_DATE=$(date -d "$CREATED_AT" +%s 2>/dev/null || date -u -d "$CREATED_AT" +%s)
            CURRENT_DATE=$(date +%s)
            DAYS_OLD=$(( (CURRENT_DATE - RELEASE_DATE) / 86400 ))
            
            if [ $DAYS_OLD -gt $DAYS_TO_KEEP ]; then
              echo "Deleting release $release (older than $DAYS_OLD days)"
              gh release delete "$release" --repo "${{ github.repository }}" --yes
            else
              echo "Keeping release $release ($DAYS_OLD days old)"
            fi
          done
