<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–æ–≥–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-950 text-white p-4">
    <div class="max-w-7xl mx-auto space-y-4">
        <h1 class="text-2xl font-bold">üîç –õ–æ–≥–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ</h1>
        
        <div id="loading" class="text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</div>
        
        <div id="results" class="space-y-4 hidden">
            <!-- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ —Ç–µ—Å—Ç—ã -->
            <div class="bg-gray-900 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-3 text-blue-400">üìã –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ —Ç–µ—Å—Ç—ã</h2>
                <div id="constants" class="space-y-2"></div>
            </div>
            
            <!-- –°—á–µ—Ç—á–∏–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö -->
            <div class="bg-gray-900 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-3 text-green-400">üî¢ –°—á–µ—Ç—á–∏–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h2>
                <div id="databaseCounts" class="space-y-3"></div>
            </div>
            
            <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ API -->
            <div class="bg-gray-900 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-3 text-yellow-400">üîÑ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ API</h2>
                <div id="apiComparison" class="space-y-3"></div>
            </div>
            
            <!-- –û–±—Ä–∞–∑—Ü—ã –∑–∞–ø–∏—Å–µ–π -->
            <div class="bg-gray-900 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-3 text-purple-400">üìù –û–±—Ä–∞–∑—Ü—ã –∑–∞–ø–∏—Å–µ–π</h2>
                <div id="sampleRecords" class="space-y-3"></div>
            </div>
            
            <!-- –ü–æ–ª–Ω—ã–µ –ª–æ–≥–∏ -->
            <div class="bg-gray-900 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-3 text-red-400">üì¶ –ü–æ–ª–Ω—ã–µ –ª–æ–≥–∏ (JSON)</h2>
                <button onclick="toggleFullLogs()" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm mb-2">
                    –ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—ã–µ –ª–æ–≥–∏
                </button>
                <pre id="fullLogs" class="text-xs text-gray-400 overflow-x-auto hidden whitespace-pre-wrap break-all"></pre>
            </div>
        </div>
        
        <div class="flex gap-4">
            <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏
            </button>
            <button onclick="downloadLogs()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">
                üíæ –°–∫–∞—á–∞—Ç—å –ª–æ–≥–∏
            </button>
        </div>
    </div>

    <script>
        let logsData = null;

        async function fetchLogs() {
            try {
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('results').classList.add('hidden');
                
                const response = await fetch('/api/logs/stats');
                logsData = await response.json();
                
                console.log('–ü–æ–ª—É—á–µ–Ω—ã –ª–æ–≥–∏:', logsData);
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('results').classList.remove('hidden');
                
                displayConstants();
                displayDatabaseCounts();
                displayApiComparison();
                displaySampleRecords();
                displayFullLogs();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('loading').innerHTML = `<div class="text-red-400">–û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        function displayConstants() {
            const constants = document.getElementById('constants');
            const { constants: consts, statusTests } = logsData;
            
            constants.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="font-semibold text-sm mb-2">MOVIE_STATUS_IDS:</h3>
                        <div class="text-xs space-y-1">
                            ${Object.entries(consts.MOVIE_STATUS_IDS).map(([key, value]) => 
                                `<div>${key}: <span class="text-green-400">${value}</span></div>`
                            ).join('')}
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-sm mb-2">–¢–µ—Å—Ç—ã –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∏–º–µ–Ω:</h3>
                        <div class="text-xs space-y-1">
                            ${Object.entries(statusTests).map(([name, id]) => 
                                `<div>"${name}" ‚Üí <span class="${id ? 'text-green-400' : 'text-red-400'}">${id || 'NULL'}</span></div>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function displayDatabaseCounts() {
            const databaseCounts = document.getElementById('databaseCounts');
            const { individualCounts, combinedCounts } = logsData.databaseChecks;
            
            databaseCounts.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h3 class="font-semibold text-sm mb-2">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏:</h3>
                        <div class="text-xs space-y-1">
                            ${Object.entries(individualCounts).map(([key, value]) => 
                                `<div>${key}: <span class="text-blue-400">${value}</span></div>`
                            ).join('')}
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-sm mb-2">–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ (–∫–∞–∫ –≤ API):</h3>
                        <div class="text-xs space-y-1">
                            ${Object.entries(combinedCounts).map(([key, value]) => 
                                `<div>${key}: <span class="text-green-400">${value}</span></div>`
                            ).join('')}
                        </div>
                    </div>
                </div>
                <div class="mt-3 p-2 bg-gray-800 rounded text-xs">
                    <strong>–ü—Ä–æ–≤–µ—Ä–∫–∞:</strong> WATCHED + REWATCHED = ${individualCounts['WATCHED (2)']} + ${individualCounts['REWATCHED (3)']} = <span class="${individualCounts['WATCHED (2)'] + individualCounts['REWATCHED (3)'] === combinedCounts['WATCHED + REWATCHED'] ? 'text-green-400' : 'text-red-400'}">${individualCounts['WATCHED (2)'] + individualCounts['REWATCHED (3)]']}</span>
                    ${individualCounts['WATCHED (2)'] + individualCounts['REWATCHED (3)'] === combinedCounts['WATCHED + REWATCHED'] ? ' ‚úÖ' : ' ‚ùå'}
                </div>
            `;
        }
        
        function displayApiComparison() {
            const apiComparison = document.getElementById('apiComparison');
            const { userStats, debugStats, userStatsError, debugStatsError } = logsData.apiComparison;
            
            let html = '';
            
            if (userStatsError) {
                html += `<div class="text-red-400 text-sm">–û—à–∏–±–∫–∞ userStats: ${userStatsError}</div>`;
            } else if (userStats) {
                html += `
                    <div class="mb-3">
                        <h3 class="font-semibold text-sm mb-2">/api/user/stats:</h3>
                        <div class="text-xs space-y-1">
                            <div>–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ: <span class="text-green-400">${userStats.watched}</span></div>
                            <div>–û—Ç–ª–æ–∂–µ–Ω–æ: <span class="text-blue-400">${userStats.wantToWatch}</span></div>
                            <div>–ë—Ä–æ—à–µ–Ω–æ: <span class="text-red-400">${userStats.dropped}</span></div>
                            <div>–°–∫—Ä—ã—Ç–æ: <span class="text-gray-400">${userStats.hidden}</span></div>
                        </div>
                    </div>
                `;
            }
            
            if (debugStatsError) {
                html += `<div class="text-red-400 text-sm">–û—à–∏–±–∫–∞ debugStats: ${debugStatsError}</div>`;
            } else if (debugStats) {
                html += `
                    <div>
                        <h3 class="font-semibold text-sm mb-2">/api/debug/stats:</h3>
                        <div class="text-xs space-y-1">
                            <div>Watched: <span class="text-green-400">${debugStats.databaseCounts?.watched || 0}</span></div>
                            <div>Rewatched: <span class="text-green-400">${debugStats.databaseCounts?.rewatched || 0}</span></div>
                            <div>Want to Watch: <span class="text-blue-400">${debugStats.databaseCounts?.wantToWatch || 0}</span></div>
                            <div>Dropped: <span class="text-red-400">${debugStats.databaseCounts?.dropped || 0}</span></div>
                        </div>
                    </div>
                `;
            }
            
            // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            if (userStats && debugStats) {
                const totalWatched = (debugStats.databaseCounts?.watched || 0) + (debugStats.databaseCounts?.rewatched || 0);
                html += `
                    <div class="mt-3 p-2 bg-gray-800 rounded text-xs">
                        <strong>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ:</strong><br>
                        –ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ: API=${userStats.watched} vs Debug=${totalWatched} 
                        <span class="${userStats.watched === totalWatched ? 'text-green-400' : 'text-red-400'}">${userStats.watched === totalWatched ? ' ‚úÖ' : ' ‚ùå'}</span><br>
                        –û—Ç–ª–æ–∂–µ–Ω–æ: API=${userStats.wantToWatch} vs Debug=${debugStats.databaseCounts?.wantToWatch || 0} 
                        <span class="${userStats.wantToWatch === (debugStats.databaseCounts?.wantToWatch || 0) ? 'text-green-400' : 'text-red-400'}">${userStats.wantToWatch === (debugStats.databaseCounts?.wantToWatch || 0) ? ' ‚úÖ' : ' ‚ùå'}</span><br>
                        –ë—Ä–æ—à–µ–Ω–æ: API=${userStats.dropped} vs Debug=${debugStats.databaseCounts?.dropped || 0} 
                        <span class="${userStats.dropped === (debugStats.databaseCounts?.dropped || 0) ? 'text-green-400' : 'text-red-400'}">${userStats.dropped === (debugStats.databaseCounts?.dropped || 0) ? ' ‚úÖ' : ' ‚ùå'}</span>
                    </div>
                `;
            }
            
            apiComparison.innerHTML = html;
        }
        
        function displaySampleRecords() {
            const sampleRecords = document.getElementById('sampleRecords');
            const records = logsData.databaseChecks.sampleRecords;
            
            let html = '';
            Object.entries(records).forEach(([status, recordList]) => {
                html += `
                    <div class="mb-3">
                        <h3 class="font-semibold text-sm mb-2">${status} (${recordList.length} –∑–∞–ø–∏—Å–µ–π):</h3>
                        <div class="space-y-1">
                            ${recordList.map(record => `
                                <div class="text-xs p-2 bg-gray-800 rounded">
                                    <div class="font-semibold">${record.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                                    <div class="text-gray-400">
                                        ID: ${record.tmdbId} | –¢–∏–ø: ${record.mediaType} | –°—Ç–∞—Ç—É—Å: ${record.statusName} (${record.statusId})
                                    </div>
                                </div>
                            `).join('')}
                            ${recordList.length === 0 ? '<div class="text-xs text-gray-500">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>' : ''}
                        </div>
                    </div>
                `;
            });
            
            sampleRecords.innerHTML = html;
        }
        
        function displayFullLogs() {
            const fullLogs = document.getElementById('fullLogs');
            fullLogs.textContent = JSON.stringify(logsData, null, 2);
        }
        
        function toggleFullLogs() {
            const fullLogs = document.getElementById('fullLogs');
            fullLogs.classList.toggle('hidden');
        }
        
        function downloadLogs() {
            const dataStr = JSON.stringify(logsData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `stats-logs-${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        fetchLogs();
    </script>
</body>
</html>
