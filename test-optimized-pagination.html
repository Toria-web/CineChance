<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –∞–∫—Ç–µ—Ä–æ–≤</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; background: #2a2a2a; border-radius: 8px; }
        .actor-card { display: inline-block; margin: 10px; padding: 15px; background: #3a3a3a; border-radius: 8px; width: 200px; vertical-align: top; }
        .actor-name { font-weight: bold; margin-bottom: 5px; }
        .actor-stats { font-size: 14px; color: #ccc; }
        .progress { width: 100%; height: 8px; background: #555; border-radius: 4px; margin: 5px 0; }
        .progress-bar { height: 100%; background: #4CAF50; border-radius: 4px; transition: width 0.3s; }
        .loading { text-align: center; padding: 20px; }
        .error { background: #8B0000; padding: 15px; border-radius: 8px; }
        .success { background: #2E7D32; padding: 15px; border-radius: 8px; }
        h1, h2, h3 { color: #4CAF50; }
        .highlight { color: #FFD700; }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .metric-card { background: #3a3a3a; padding: 15px; border-radius: 8px; text-align: center; }
        .metric-value { font-size: 24px; font-weight: bold; color: #4CAF50; }
        .metric-label { font-size: 14px; color: #ccc; margin-top: 5px; }
        button { background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #45a049; }
        button:disabled { background: #666; cursor: not-allowed; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .old-method, .new-method { background: #2a2a2a; padding: 15px; border-radius: 8px; }
        .old-method h3 { color: #ff6b6b; }
        .new-method h3 { color: #4CAF50; }
        .performance-test { background: #2a2a2a; padding: 15px; border-radius: 8px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ –¢–µ—Å—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –∞–∫—Ç–µ—Ä–æ–≤</h1>
        
        <div class="section">
            <h3>üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</h3>
            <div class="comparison">
                <div class="old-method">
                    <h3>‚ùå –°—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥</h3>
                    <ul>
                        <li>–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ä–∞–∑—É 50 –∞–∫—Ç–µ—Ä–æ–≤</li>
                        <li>–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ 50 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ TMDB</li>
                        <li>–î–æ–ª–≥–∞—è initial –∑–∞–≥—Ä—É–∑–∫–∞</li>
                        <li>–í–∏–∑—É–∞–ª—å–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏</li>
                        <li>–í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Ä–µ—Å—É—Ä—Å—ã</li>
                    </ul>
                </div>
                <div class="new-method">
                    <h3>‚úÖ –ù–æ–≤—ã–π –º–µ—Ç–æ–¥</h3>
                    <ul>
                        <li>–ü–∞–≥–∏–Ω–∞—Ü–∏—è –ø–æ 24 –∞–∫—Ç–µ—Ä–∞</li>
                        <li>–ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –±—ã—Å—Ç—Ä–æ</li>
                        <li>–§–∏–ª—å–º–æ–≥—Ä–∞—Ñ–∏—è –¥–æ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏</li>
                        <li>–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–æ–≥—Ä–∞—Ñ–∏–∏</li>
                        <li>–ë—ã—Å—Ç—Ä–∞—è initial –∑–∞–≥—Ä—É–∑–∫–∞</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>‚ö° –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</h3>
            <div class="metrics">
                <div class="metric-card">
                    <div class="metric-value" id="load-time">-</div>
                    <div class="metric-label">–í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ (–º—Å)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="actors-count">-</div>
                    <div class="metric-label">–ê–∫—Ç–µ—Ä–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="api-requests">-</div>
                    <div class="metric-label">API –∑–∞–ø—Ä–æ—Å–æ–≤</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="cache-hits">-</div>
                    <div class="metric-label">–ö—ç—à –ø–æ–ø–∞–¥–∞–Ω–∏—è</div>
                </div>
            </div>
        </div>

        <div class="performance-test">
            <h3>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</h3>
            <button onclick="testBasicLoad()">–¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏</button>
            <button onclick="testFullLoad()">–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏</button>
            <button onclick="testPagination()">–¢–µ—Å—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏–∏</button>
            <button onclick="clearResults()">–û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
            <div id="test-results"></div>
        </div>

        <div class="section">
            <h2>üé¨ –ê–∫—Ç–µ—Ä—ã (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)</h2>
            <div id="actors-container" class="loading">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
            </div>
            <div style="text-align: center; margin: 20px 0;">
                <button id="load-more-btn" onclick="loadMore()" style="display: none;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ</button>
            </div>
        </div>

        <div class="section">
            <h2>üîç –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
            <div id="debug-info">
                <p>–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏...</p>
            </div>
        </div>
    </div>

    <script>
        let actors = [];
        let offset = 0;
        let hasMore = true;
        let total = 0;
        let apiRequestCount = 0;
        let startTime = 0;

        async function fetchActors(loadFullData = false, append = false) {
            const startTime = performance.now();
            apiRequestCount++;
            
            try {
                const params = new URLSearchParams({
                    limit: '24',
                    offset: offset.toString(),
                    fullData: loadFullData.toString(),
                });
                
                console.log(`üé¨ –ó–∞–ø—Ä–æ—Å –∞–∫—Ç–µ—Ä–æ–≤: offset=${offset}, fullData=${loadFullData}`);
                const response = await fetch(`/api/user/achiev_actors?${params}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const loadTime = performance.now() - startTime;
                
                console.log('üìä –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', data);
                
                if (data.actors && Array.isArray(data.actors)) {
                    if (append) {
                        actors = [...actors, ...data.actors];
                    } else {
                        actors = data.actors;
                    }
                    
                    hasMore = data.hasMore || false;
                    total = data.total || 0;
                    offset += data.actors.length;
                    
                    updateMetrics(loadTime);
                    updateDebugInfo(data, loadTime);
                    renderActors();
                }
                
                return data;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                document.getElementById('actors-container').innerHTML = 
                    `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
                return null;
            }
        }

        function updateMetrics(loadTime) {
            document.getElementById('load-time').textContent = Math.round(loadTime);
            document.getElementById('actors-count').textContent = actors.length;
            document.getElementById('api-requests').textContent = apiRequestCount;
        }

        function updateDebugInfo(data, loadTime) {
            const debugContainer = document.getElementById('debug-info');
            debugContainer.innerHTML = `
                <h3>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–≤–µ—Ç–∞:</h3>
                <p>üé≠ –ê–∫—Ç–µ—Ä–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ: ${data.actors?.length || 0}</p>
                <p>üì∫ –í—Å–µ–≥–æ –∞–∫—Ç–µ—Ä–æ–≤: ${data.total || 0}</p>
                <p>üîÑ –ï—Å—Ç—å –µ—â–µ: ${data.hasMore ? '–î–∞' : '–ù–µ—Ç'}</p>
                <p>‚è±Ô∏è –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏: ${Math.round(loadTime)}–º—Å</p>
                <p>üåê API –∑–∞–ø—Ä–æ—Å–æ–≤: ${apiRequestCount}</p>
                <h4>üîç –ü–µ—Ä–≤—ã–µ 3 –∞–∫—Ç–µ—Ä–∞:</h4>
                <pre>${JSON.stringify(data.actors?.slice(0, 3) || [], null, 2)}</pre>
            `;
        }

        function renderActors() {
            const container = document.getElementById('actors-container');
            const loadMoreBtn = document.getElementById('load-more-btn');
            
            if (actors.length === 0) {
                container.innerHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ª—é–±–∏–º—ã—Ö –∞–∫—Ç–µ—Ä–æ–≤</p>';
                loadMoreBtn.style.display = 'none';
                return;
            }
            
            container.innerHTML = actors.map(actor => `
                <div class="actor-card">
                    <div class="actor-name">${actor.name}</div>
                    <div class="actor-stats">
                        üì∫ –ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ: ${actor.watched_movies} / ${actor.total_movies}
                    </div>
                    <div class="progress">
                        <div class="progress-bar" style="width: ${actor.progress_percent}%"></div>
                    </div>
                    <div class="actor-stats">
                        üìä –ü—Ä–æ–≥—Ä–µ—Å—Å: ${actor.progress_percent}%
                        ${actor.average_rating ? `‚≠ê –†–µ–π—Ç–∏–Ω–≥: ${actor.average_rating}` : ''}
                        ${actor.total_movies === 0 ? '<br><span style="color: #ff9800;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–ª—å–º–æ–≥—Ä–∞—Ñ–∏–∏...</span>' : ''}
                    </div>
                </div>
            `).join('');
            
            loadMoreBtn.style.display = hasMore ? 'inline-block' : 'none';
        }

        async function loadMore() {
            if (!hasMore) return;
            
            const btn = document.getElementById('load-more-btn');
            btn.disabled = true;
            btn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            
            await fetchActors(false, true);
            
            // –î–æ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—É—é —Ñ–∏–ª—å–º–æ–≥—Ä–∞—Ñ–∏—é –¥–ª—è –Ω–æ–≤—ã—Ö –∞–∫—Ç–µ—Ä–æ–≤
            const newActors = actors.slice(-24);
            if (newActors.some(actor => actor.total_movies === 0)) {
                await fetchActors(true, false);
            }
            
            btn.disabled = false;
            btn.textContent = '–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â–µ';
        }

        // –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        async function testBasicLoad() {
            resetCounters();
            startTime = performance.now();
            await fetchActors(false, false);
            addTestResult('–ë–∞–∑–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞', performance.now() - startTime);
        }

        async function testFullLoad() {
            resetCounters();
            startTime = performance.now();
            await fetchActors(true, false);
            addTestResult('–ü–æ–ª–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞', performance.now() - startTime);
        }

        async function testPagination() {
            resetCounters();
            startTime = performance.now();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω–∏—Ü
            await fetchActors(false, false);
            await fetchActors(false, true);
            await fetchActors(false, true);
            
            addTestResult('–ü–∞–≥–∏–Ω–∞—Ü–∏—è (3 —Å—Ç—Ä–∞–Ω–∏—Ü—ã)', performance.now() - startTime);
        }

        function resetCounters() {
            actors = [];
            offset = 0;
            hasMore = true;
            total = 0;
            apiRequestCount = 0;
        }

        function addTestResult(testName, duration) {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = duration < 1000 ? 'success' : 'error';
            resultDiv.innerHTML = `
                <strong>${testName}:</strong> ${Math.round(duration)}–º—Å 
                ${duration < 1000 ? '‚úÖ –ë—ã—Å—Ç—Ä–æ' : '‚ö†Ô∏è –ú–µ–¥–ª–µ–Ω–Ω–æ'}
            `;
            resultsDiv.appendChild(resultDiv);
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            resetCounters();
            renderActors();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            fetchActors(false, false);
        });
    </script>
</body>
</html>
