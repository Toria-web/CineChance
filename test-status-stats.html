<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-950 text-white p-8">
    <div class="max-w-6xl mx-auto space-y-6">
        <h1 class="text-2xl font-bold">–¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h1>
        
        <div id="loading" class="text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        
        <div id="results" class="space-y-4 hidden">
            <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="bg-gray-900 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-3">–û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (/api/user/stats)</h2>
                <div id="mainStats" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                <div id="mainDebug" class="mt-3 text-xs text-gray-400"></div>
            </div>
            
            <!-- Debug —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="bg-gray-900 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-3">Debug —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (/api/debug/stats)</h2>
                <div id="debugStats" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                <div id="debugDetails" class="mt-3"></div>
            </div>
            
            <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö -->
            <div class="bg-gray-900 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-3">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h2>
                <div id="comparison" class="space-y-2"></div>
            </div>
            
            <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∑–∞–ø–∏—Å—è–º -->
            <div class="bg-gray-900 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-3">–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∑–∞–ø–∏—Å—è–º</h2>
                <div id="detailedRecords" class="space-y-2 max-h-96 overflow-y-auto"></div>
            </div>
        </div>
        
        <div class="flex gap-4">
            <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">
                –û–±–Ω–æ–≤–∏—Ç—å
            </button>
            <button onclick="testMyMoviesAPI()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded">
                –ü—Ä–æ–≤–µ—Ä–∏—Ç—å /api/my-movies
            </button>
            <button onclick="window.open('/test-logs-browser.html', '_blank')" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded">
                üìã –û—Ç–∫—Ä—ã—Ç—å –ª–æ–≥–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
            </button>
        </div>
    </div>

    <script>
        let mainStatsData = null;
        let debugStatsData = null;

        async function fetchStats() {
            try {
                console.log('=== –ó–ê–ü–†–û–° –°–¢–ê–¢–ò–°–¢–ò–ö–ò –ü–û –°–¢–ê–¢–£–°–ê–ú ===');
                
                // –ü–æ–ª—É—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const mainResponse = await fetch('/api/user/stats');
                mainStatsData = await mainResponse.json();
                console.log('–û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:', mainStatsData);
                
                // –ü–æ–ª—É—á–∞–µ–º debug —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                const debugResponse = await fetch('/api/debug/stats');
                debugStatsData = await debugResponse.json();
                console.log('Debug —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:', debugStatsData);
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('results').classList.remove('hidden');
                
                displayMainStats();
                displayDebugStats();
                displayComparison();
                displayDetailedRecords();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('loading').innerHTML = `<div class="text-red-400">–û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }
        
        function displayMainStats() {
            const mainStats = document.getElementById('mainStats');
            const total = mainStatsData.total || {};
            
            mainStats.innerHTML = `
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-400">${total.watched || 0}</div>
                    <div class="text-sm text-gray-400">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</div>
                    <div class="text-xs text-gray-500">–≤–∫–ª—é—á–∞—è –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ–Ω–æ</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-400">${total.wantToWatch || 0}</div>
                    <div class="text-sm text-gray-400">–û—Ç–ª–æ–∂–µ–Ω–æ</div>
                    <div class="text-xs text-gray-500">–•–æ—á—É –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-red-400">${total.dropped || 0}</div>
                    <div class="text-sm text-gray-400">–ë—Ä–æ—à–µ–Ω–æ</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-gray-400">${total.hidden || 0}</div>
                    <div class="text-sm text-gray-400">–°–∫—Ä—ã—Ç–æ</div>
                    <div class="text-xs text-gray-500">blacklist</div>
                </div>
            `;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            const mainDebug = document.getElementById('mainDebug');
            if (mainStatsData.debug) {
                mainDebug.innerHTML = `
                    <div class="font-semibold mb-1">Debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</div>
                    <div>Total for percentage: ${mainStatsData.debug.rawCounts?.totalForPercentage || 0}</div>
                    <div>Timestamp: ${mainStatsData.debug.timestamp}</div>
                `;
            }
        }
        
        function displayDebugStats() {
            const debugStats = document.getElementById('debugStats');
            const counts = debugStatsData.databaseCounts || {};
            
            debugStats.innerHTML = `
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-400">${counts.watched || 0}</div>
                    <div class="text-sm text-gray-400">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ</div>
                    <div class="text-xs text-gray-500">—Ç–æ–ª—å–∫–æ WATCHED</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600">${counts.rewatched || 0}</div>
                    <div class="text-sm text-gray-400">–ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ–Ω–æ</div>
                    <div class="text-xs text-gray-500">—Ç–æ–ª—å–∫–æ REWATCHED</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-400">${counts.wantToWatch || 0}</div>
                    <div class="text-sm text-gray-400">–û—Ç–ª–æ–∂–µ–Ω–æ</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-red-400">${counts.dropped || 0}</div>
                    <div class="text-sm text-gray-400">–ë—Ä–æ—à–µ–Ω–æ</div>
                </div>
            `;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â–∏–µ —Å—É–º–º—ã
            const debugDetails = document.getElementById('debugDetails');
            const totalWatched = (counts.watched || 0) + (counts.rewatched || 0);
            debugDetails.innerHTML = `
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <div class="font-semibold">–°—É–º–º—ã:</div>
                        <div>–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ + –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ–Ω–æ: ${totalWatched}</div>
                        <div>–í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö: ${totalWatched + (counts.wantToWatch || 0) + (counts.dropped || 0)}</div>
                    </div>
                    <div>
                        <div class="font-semibold">–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã —Å—Ç–∞—Ç—É—Å–æ–≤:</div>
                        <div>WANT_TO_WATCH: ${debugStatsData.statusConstants?.MOVIE_STATUS_IDS?.WANT_TO_WATCH}</div>
                        <div>WATCHED: ${debugStatsData.statusConstants?.MOVIE_STATUS_IDS?.WATCHED}</div>
                        <div>REWATCHED: ${debugStatsData.statusConstants?.MOVIE_STATUS_IDS?.REWATCHED}</div>
                        <div>DROPPED: ${debugStatsData.statusConstants?.MOVIE_STATUS_IDS?.DROPPED}</div>
                    </div>
                </div>
            `;
        }
        
        function displayComparison() {
            const comparison = document.getElementById('comparison');
            const main = mainStatsData.total || {};
            const debug = debugStatsData.databaseCounts || {};
            
            const totalWatched = (debug.watched || 0) + (debug.rewatched || 0);
            
            const comparisons = [
                {
                    name: '–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–æ (–≤–∫–ª—é—á–∞—è –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ–Ω–æ)',
                    main: main.watched || 0,
                    debug: totalWatched,
                    status: (main.watched || 0) === totalWatched ? '‚úÖ' : '‚ùå'
                },
                {
                    name: '–û—Ç–ª–æ–∂–µ–Ω–æ',
                    main: main.wantToWatch || 0,
                    debug: debug.wantToWatch || 0,
                    status: (main.wantToWatch || 0) === (debug.wantToWatch || 0) ? '‚úÖ' : '‚ùå'
                },
                {
                    name: '–ë—Ä–æ—à–µ–Ω–æ',
                    main: main.dropped || 0,
                    debug: debug.dropped || 0,
                    status: (main.dropped || 0) === (debug.dropped || 0) ? '‚úÖ' : '‚ùå'
                }
            ];
            
            comparison.innerHTML = comparisons.map(comp => `
                <div class="flex justify-between items-center p-2 bg-gray-800 rounded">
                    <span class="text-sm">${comp.name}</span>
                    <div class="flex items-center gap-4">
                        <span class="text-xs">API: ${comp.main}</span>
                        <span class="text-xs">Debug: ${comp.debug}</span>
                        <span class="text-sm">${comp.status}</span>
                    </div>
                </div>
            `).join('');
        }
        
        function displayDetailedRecords() {
            const detailedRecords = document.getElementById('detailedRecords');
            
            if (debugStatsData.sampleRecords && debugStatsData.sampleRecords.length > 0) {
                const header = document.createElement('div');
                header.className = 'font-semibold text-sm mb-2';
                header.textContent = `–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø–∏—Å–µ–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ë—Ä–æ—à–µ–Ω–æ":`;
                detailedRecords.appendChild(header);
                
                debugStatsData.sampleRecords.forEach(record => {
                    const recordDiv = document.createElement('div');
                    recordDiv.className = 'p-2 bg-gray-800 rounded text-xs';
                    recordDiv.innerHTML = `
                        <div class="font-semibold">${record.title}</div>
                        <div class="text-gray-400">
                            –°—Ç–∞—Ç—É—Å: ${record.statusName} (${record.statusId}) | 
                            –¢–∏–ø: ${record.mediaType} | 
                            ID: ${record.tmdbId}
                        </div>
                        <div class="text-gray-500">
                            –î–æ–±–∞–≤–ª–µ–Ω–æ: ${new Date(record.addedAt).toLocaleString()}
                            ${record.userRating ? ` | –û—Ü–µ–Ω–∫–∞: ${record.userRating}` : ''}
                        </div>
                    `;
                    detailedRecords.appendChild(recordDiv);
                });
            } else {
                detailedRecords.innerHTML = '<div class="text-gray-400 text-sm">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
            }
        }
        
        async function testMyMoviesAPI() {
            try {
                console.log('=== –¢–ï–°–¢ /api/my-movies ===');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã
                const statuses = ['watched', 'want_to_watch', 'dropped', 'hidden'];
                const results = {};
                
                for (const status of statuses) {
                    const response = await fetch(`/api/my-movies?status=${status}`);
                    const data = await response.json();
                    results[status] = Array.isArray(data) ? data.length : 0;
                    console.log(`Status ${status}: ${results[status]} –∑–∞–ø–∏—Å–µ–π`);
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                const detailedRecords = document.getElementById('detailedRecords');
                const resultsDiv = document.createElement('div');
                resultsDiv.className = 'p-3 bg-yellow-900/20 rounded mb-3';
                resultsDiv.innerHTML = `
                    <h3 class="font-semibold text-sm mb-2">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã /api/my-movies:</h3>
                    ${Object.entries(results).map(([status, count]) => 
                        `<div class="text-xs">${status}: ${count} –∑–∞–ø–∏—Å–µ–π</div>`
                    ).join('')}
                `;
                detailedRecords.insertBefore(resultsDiv, detailedRecords.firstChild);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–µ /api/my-movies:', error);
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        fetchStats();
    </script>
</body>
</html>
